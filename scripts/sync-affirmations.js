import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 1. Read the base file which currently has ~278
const baseFile = path.join(__dirname, '../src/data/affirmations.json');
const rawBase = fs.readFileSync(baseFile, 'utf8');
const baseAffirmations = JSON.parse(rawBase);

// 2. Read all the other batches
const batches = [
    '../src/data/affirmations-batch6.json'
];

let finalItems = [...baseAffirmations];

for (const batch of batches) {
    const batchPath = path.join(__dirname, batch);
    if (fs.existsSync(batchPath)) {
        const rawBatch = fs.readFileSync(batchPath, 'utf8');
        const parsedBatch = JSON.parse(rawBatch);
        finalItems = finalItems.concat(parsedBatch);
    }
}

// Eliminate any potential duplicates based on text exactly, and fix IDs iteratively
const uniqueTexts = new Set();
let cleanItems = [];
let nextId = 1;

for (let item of finalItems) {
    if (!uniqueTexts.has(item.text)) {
        uniqueTexts.add(item.text);
        item.id = String(nextId++);
        cleanItems.push(item);
    }
}

// Write the combined and clean array back to the main JSON file
fs.writeFileSync(baseFile, JSON.stringify(cleanItems, null, 2));

// Delete the temporary batches
for (const batch of batches) {
    const batchPath = path.join(__dirname, batch);
    if (fs.existsSync(batchPath)) {
        fs.unlinkSync(batchPath);
    }
}

const workerContent = `// Auto-generated by sync-affirmations.js
export interface Affirmation {
    id: string;
    text: string;
    author: string;
    category: string;
}

const moodMapping: Record<string, string[]> = {
    Calma: ['Ansiedad', 'Estrés', 'Paz', 'Relajación', 'Calma', 'Serenidad', 'Entrega'],
    Fuerza: ['Motivación', 'Poder', 'Éxito', 'Protección', 'Libertad', 'Insight'],
    Amor: ['Amor', 'Relaciones', 'Familia', 'Perdón', 'Comunidad', 'Autoestima'],
    Crecimiento: ['Crecimiento', 'Insight', 'Intuición', 'Creatividad'],
    Bienestar: ['Salud', 'Autocuidado', 'Sanación', 'Bienestar'],
    Abundancia: ['Abundancia', 'Gratitud', 'Alegría', 'Dicha', 'Agradecimiento'],
    Confianza: ['Confianza', 'Seguridad', 'Amor Propio', 'Valor', 'Apoyo', 'Liberación'],
    Claridad: ['Enfoque', 'Mentalidad', 'Conciencia', 'Presencia', 'Revelación', 'Mente'],
};

const affirmations: Affirmation[] = ${JSON.stringify(cleanItems.map((i) => ({ id: i.id, text: i.text, author: i.author, category: i.category })), null, 4)};

export function getAffirmationsByMood(mood: string): Affirmation[] {
    if (mood === 'Todas') return affirmations;
    const subCategories = moodMapping[mood] || [];
    if (subCategories.length === 0) {
        return affirmations.filter(a => a.category.toLowerCase() === mood.toLowerCase());
    }
    return affirmations.filter(a =>
        subCategories.some(sub => sub.toLowerCase() === a.category.toLowerCase())
    );
}

export function getRandomAffirmation(mood: string): Affirmation {
    const list = getAffirmationsByMood(mood);
    if (list.length === 0) return affirmations[0];
    return list[Math.floor(Math.random() * list.length)];
}
`;

fs.writeFileSync(path.join(__dirname, '../ancla-push-worker/src/affirmations.ts'), workerContent);

console.log('Script completed. Combined ' + cleanItems.length + ' affirmations from all batches into 1st person.');
